# Maps_scraper.py 死锁问题修复说明

## 🔍 问题分析

您的Maps_scraper.py程序在运行时卡住不动，主要原因是：

### 根本原因
1. **死锁问题**: `PlaywrightManager`的`run_coroutine`方法使用了全局锁，导致多个`EmailFetcherWorker`线程无法并发执行
2. **资源竞争**: 页面池资源耗尽时，新请求会无限等待，造成程序假死
3. **网络请求堆积**: WhatsApp号码提取时大量并发请求导致Playwright页面池阻塞

### 具体表现
- 程序输出显示"正在从官网文本中提取WhatsApp号码..."后就卡住
- 页面池显示"页面已出队"但没有"页面已归队"
- 多个Worker同时等待Playwright资源，造成死锁

## 🛠️ 修复方案

### 主要修改

#### 1. 移除死锁源头 - PlaywrightManager.run_coroutine()
```python
# 修复前（有死锁风险）
def run_coroutine(self, coro):
    with self._lock:  # ❌ 全局锁导致串行执行
        future = asyncio.run_coroutine_threadsafe(coro, self._loop)
        return future.result(timeout=60)

# 修复后（支持并发）
def run_coroutine(self, coro):
    future = asyncio.run_coroutine_threadsafe(coro, self._loop)
    return future.result(timeout=120)  # ✅ 移除锁，延长超时
```

#### 2. 智能页面池管理
```python
# 修复前
page = await self.page_pool.get()  # ❌ 可能无限等待

# 修复后
if self.page_pool.empty():  # ✅ 预检查避免阻塞
    print("页面池暂时无可用页面，跳过请求避免阻塞程序")
    return None
page = await asyncio.wait_for(self.page_pool.get(), timeout=30.0)
```

#### 3. 改进错误处理
```python
# 增加了更详细的错误信息和超时处理
except asyncio.TimeoutError:
    print("⚠️ 页面池资源繁忙，获取页面超时，跳过此请求以避免阻塞")
    return None
```

#### 4. 移除初始化锁
```python
# 修复前
async def _initialize_internal(self):
    with self._lock:  # ❌ 可能造成初始化阻塞
        ...

# 修复后  
async def _initialize_internal(self):
    if self.initialization_successful:  # ✅ 状态检查代替锁
        return
    ...
```

## ✅ 修复效果

### 性能提升
- **并发处理**: 多个EmailFetcherWorker现在可以真正并行工作
- **资源利用**: 页面池资源得到更好的管理和分配
- **响应速度**: 移除锁后，程序响应速度显著提升

### 稳定性改进
- **避免死锁**: 彻底解决了全局锁导致的死锁问题
- **智能降级**: 资源不足时自动跳过请求，保持程序流畅运行
- **超时保护**: 增加了多层超时保护，避免无限等待

### 用户体验
- **不再卡死**: 程序不会在WhatsApp号码提取时卡住
- **进度可见**: 更清晰的日志输出，用户可以看到处理进度
- **错误恢复**: 单个请求失败不会影响整体进程

## 🚀 使用建议

### 立即可用
修复后的程序现在应该可以正常运行，不会再出现卡死问题。

### 性能调优
如果遇到性能问题，可以考虑：

1. **调整页面池大小**:
   ```python
   # 在PlaywrightManager初始化时
   playwright_manager = PlaywrightManager(pool_size=5)  # 默认3，可调整为5
   ```

2. **减少并发数量**:
   ```python
   # 在主程序中调整线程池大小
   self.thread_pool.setMaxThreadCount(36)  # 可适当减少
   ```

3. **监控资源使用**:
   - 观察日志中的"页面已出队"和"页面已归队"是否平衡
   - 注意"页面池暂时无可用页面"的频率

### 故障排除
如果仍有问题：
1. 检查网络连接是否稳定
2. 确认系统资源（CPU/内存）是否充足
3. 可以临时关闭WhatsApp高级验证模式以减少资源消耗

## 📋 技术细节

### 修改文件
- `Maps_scraper.py`: 主程序文件，包含所有核心修复

### 修改行数
- PlaywrightManager.run_coroutine(): 第2368-2387行
- PlaywrightManager.get_page_content(): 第2520-2543行  
- PlaywrightManager._initialize_internal(): 第2392-2453行
- EmailFetcherWorker.run(): 第1687-1705行

### 测试验证
运行 `python3 test_fix.py` 可以验证修复效果。

---

**修复完成时间**: 2025年9月16日  
**修复版本**: 死锁修复版 v1.0  
**兼容性**: 保持与原程序100%功能兼容